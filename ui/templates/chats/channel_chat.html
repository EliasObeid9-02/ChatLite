{% extends is_htmx_request|yesno:"_base.html,base.html" %}
{% load tz %}
{% block layout %}
    <div class="container" ws-connect="/ws/chat/{{ channel.id }}/">
        <div class="box" style="display: flex; flex-direction: column; height: 85vh;">
            <div class="level">
                <div class="level-left">
                    <div>
                        <h2 class="title is-4">{{ channel.name }}</h2>
                        <p class="subtitle is-6">{{ members_count }} members</p>
                    </div>
                </div>
                <div class="level-right">
                    <a href="{% url 'chats:channel-details' channel_id=channel.id %}"
                       class="button is-info">Details</a>
                </div>
            </div>
            <div class="content" id="chat-log" style="flex-grow: 1; overflow-y: auto;">
                {% for group in grouped_messages %}
                    {% include "chats/partials/_message_group.html" with group=group %}
                {% empty %}
                    <p id="no-messages-p" class="has-text-centered">No messages yet. Be the first to say something!</p>
                {% endfor %}
            </div>
            <form id="chat-form" ws-send>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input type="hidden" name="type" value="message">
                        {% csrf_token %}
                        {{ form.content }}
                    </div>
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            <span class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     viewBox="0 0 640 640"
                                     fill="currentColor">
                                    <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                    <path d="M568.4 37.7C578.2 34.2 589 36.7 596.4 44C603.8 51.3 606.2 62.2 602.7 72L424.7 568.9C419.7 582.8 406.6 592 391.9 592C377.7 592 364.9 583.4 359.6 570.3L295.4 412.3C290.9 401.3 292.9 388.7 300.6 379.7L395.1 267.3C400.2 261.2 399.8 252.3 394.2 246.7C388.6 241.1 379.6 240.7 373.6 245.8L261.2 340.1C252.1 347.7 239.6 349.7 228.6 345.3L70.1 280.8C57 275.5 48.4 262.7 48.4 248.5C48.4 233.8 57.6 220.7 71.5 215.7L568.4 37.7z" />
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <form id="reaction-form" ws-send style="display: none;">
            <input type="hidden" name="type" value="reaction">
            <input type="hidden" name="message_id" id="reaction-message-id">
            <input type="hidden" name="emoji" id="reaction-emoji">
        </form>
    </div>
    <script>
        function scrollToBottom() {
            const chatLog = document.getElementById('chat-log');
            if (chatLog) {
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', scrollToBottom);
        document.addEventListener('htmx:afterSwap', scrollToBottom);
        document.body.addEventListener('htmx:wsAfterMessage', scrollToBottom);
        document.addEventListener('htmx:wsAfterSend', function (evt) {
            const messageInput = document.querySelector('[name="content"]');
            if (messageInput) {
                messageInput.value = '';
            }
            scrollToBottom(); // Scroll to bottom after sending a message
        });

        // Reaction menu logic
        const reactionEmojis = ['👍', '❤️', '😂', '😮', '😢'];
        let reactionMenu = null;

        function createReactionMenu(messageId, x, y) {
            if (reactionMenu) {
                reactionMenu.remove();
            }

            reactionMenu = document.createElement('div');
            reactionMenu.classList.add('reaction-menu');
            reactionMenu.style.left = `${x}px`;
            reactionMenu.style.top = `${y}px`;

            reactionEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.classList.add('reaction-menu-item');
                button.textContent = emoji;
                button.addEventListener('click', () => {
                    document.getElementById('reaction-message-id').value = messageId;
                    document.getElementById('reaction-emoji').value = emoji;
                    htmx.trigger('#reaction-form', 'submit');
                    reactionMenu.remove();
                    reactionMenu = null;
                });
                reactionMenu.appendChild(button);
            });

            document.body.appendChild(reactionMenu);

            // Close menu if clicked outside
            document.addEventListener('click', function closeMenu(event) {
                if (reactionMenu && !reactionMenu.contains(event.target) && !event.target.closest('.message')) {
                    reactionMenu.remove();
                    reactionMenu = null;
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        const chatLog = document.getElementById('chat-log');
        if (chatLog) {
            chatLog.addEventListener('contextmenu', function (e) {
                const messageElement = e.target.closest('.message');
                if (messageElement) {
                    e.preventDefault();
                    const messageId = messageElement.dataset.messageId;
                    createReactionMenu(messageId, e.pageX, e.pageY);
                }
            });
        }
    </script>
{% endblock %}
