<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatLite</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css"
    />
    <link rel="stylesheet" href="/static/css/custom.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"
      integrity="sha384-ZBXiYtYQ6hJ2Y0ZNoYuI+Nq5MqWBr+chMrS/RkXpNzQCApHEhOt2aY8EJgqwHLkJ"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/htmx-ext-ws@2.0.2"
      integrity="sha384-vuKxTKv5TX/b3lLzDKP2U363sOAoRo5wSvzzc3LJsbaQRSBSS+3rKKHcOx5J8doU"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.cookie =
          "django_timezone=" + timezone + ";path=/;max-age=" + 7 * 24 * 60 * 60;

        // Navbar burger toggle
        const burger = document.querySelector(".navbar-burger");
        const menu = document.querySelector(".navbar-menu");
        if (burger && menu) {
          burger.addEventListener("click", function () {
            burger.classList.toggle("is-active");
            menu.classList.toggle("is-active");
          });
        }
      });

      function highlightActiveChannel() {
        const currentPath = window.location.pathname;
        const channelLinks = document.querySelectorAll(".menu-list a");

        channelLinks.forEach((link) => {
          link.classList.remove("is-active");
          if (link.getAttribute("href") === currentPath) {
            link.classList.add("is-active");
          }
        });
      }

      // Call after every HTMX swap
      document.addEventListener("DOMContentLoaded", highlightActiveChannel);
      document.addEventListener("htmx:afterSwap", highlightActiveChannel);
    </script>
  </head>

  <body hx-boost="true" hx-target="#content" hx-ext="ws">
    <div class="container is-fluid">
      <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <a href="{% url 'chats:home' %}" class="navbar-item">ChatLite</a>
          <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>
        <div class="navbar-menu">
          <div class="navbar-end">
            {% if user.is_authenticated %}
            <a
              href="{% url 'users:profile' username=user.username %}"
              class="navbar-item"
              >Profile</a
            >
            <a
              href="#"
              class="navbar-item"
              hx-post="{% url 'users:logout' %}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              hx-confirm="Are you sure you want to logout?"
              >Logout</a
            >
            {% else %}
            <a href="{% url 'users:login' %}" class="navbar-item">Login</a>
            <a href="{% url 'users:register' %}" class="navbar-item"
              >Register</a
            >
            {% endif %}
          </div>
        </div>
      </nav>
      <hr class="mt-0 has-background-grey" />
      <div class="columns">
        {% if user.is_authenticated %}
        <div class="column is-one-fifth is-flex is-flex-direction-column">
          <aside class="menu is-flex-grow-1">
            <div class="is-flex is-justify-content-space-between is-align-items-center">
              <p class="menu-label">Channels</p>
              <a href="{% url 'chats:channel-create' %}" class="has-text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="24" height="24" fill="currentColor">
                  <path d="M352 128C352 110.3 337.7 96 320 96C302.3 96 288 110.3 288 128L288 288L128 288C110.3 288 96 302.3 96 320C96 337.7 110.3 352 128 352L288 352L288 512C288 529.7 302.3 544 320 544C337.7 544 352 529.7 352 512L352 352L512 352C529.7 352 544 337.7 544 320C544 302.3 529.7 288 512 288L352 288L352 128z"/>
                </svg>
              </a>
            </div>
            <ul class="menu-list">
              {% for channel in channels %}
              <li>
                <a href="{% url 'chats:channel-chat' channel_id=channel.id %}"
                  >{{ channel.name }}</a
                >
              </li>
              {% empty %}
              <li>
                <small>No channels yet. Create or join one!</small>
              </li>
              {% endfor %}
            </ul>
          </aside>
        </div>
        {% endif %}
        <main id="content" class="column">
          {% block layout %}{% endblock %}
        </main>
      </div>
    </div>
  </body>
</html>
